/*
 * Creación de la base de datos "Viveros"
 * Autor: Edwin Plasencia Hernández - <alu0101329888@ull.edu.es>
 *
 * Uso:
 * sudo su postgres
 *   psql
 *   \i viveros.sql
 */

DROP SCHEMA public CASCADE;
CREATE SCHEMA public;

DROP DATABASE IF EXISTS VIVEROS;
CREATE DATABASE VIVEROS;

/*
 * El CHECK procura que el numero de telefono sea del estilo +XX XXX XXX XXX
 */

CREATE TABLE CLIENTES(
  DNI VARCHAR(9) NOT NULL UNIQUE,
  NOMBRE VARCHAR(20) NULL,
  APELLIDO1 VARCHAR(20) NULL,
  APELLIDO2 VARCHAR(20) NULL,
  FECHA_NACIMIENTO DATE CHECK (FECHA_NACIMIENTO < CURRENT_DATE) NULL,
  EDAD INTERVAL NULL,
  COMPRAS_DESDE_INCLUSION INT NULL,
  COMPRAS_MES INT NULL
);

/*
 * Es necesario un trigger para calcular las compras del mes y desde inclusion al club
 * Es necesario un trigger o view para calcular la edad ya que postgresql no permite el uso de generated always as y virtual
 */

CREATE TABLE CLUB(
  DNI VARCHAR(9) NOT NULL,
  FECHA_INCLUSION DATE CHECK (FECHA_INCLUSION <= CURRENT_DATE) NULL,
  FECHA_CADUCIDAD DATE CHECK (FECHA_CADUCIDAD > FECHA_INCLUSION) NULL,
  PRIMARY KEY(DNI, FECHA_INCLUSION),
  CONSTRAINT FK_CLIENTES
    FOREIGN KEY(DNI)
      REFERENCES CLIENTES(DNI)
      ON DELETE CASCADE
);

CREATE TABLE VIVEROS(
  NOMBRE VARCHAR(20) NOT NULL,
  LUGAR VARCHAR(50) NOT NULL,
  PRIMARY KEY(NOMBRE)
);

CREATE TABLE ZONAS(
  ID INT GENERATED ALWAYS AS IDENTITY,
  LATITUD REAL CHECK (LATITUD <= 90 AND LATITUD >= -90) NOT NULL,
  LONGITUD REAL CHECK (LONGITUD <= 180 AND LONGITUD >= -180) NOT NULL,
  NOMBRE VARCHAR(20) NOT NULL,
  VIVERO VARCHAR(20) NOT NULL,
  PRIMARY KEY(ID),
  CONSTRAINT FK_VIVEROS
    FOREIGN KEY(VIVERO)
      REFERENCES VIVEROS(NOMBRE)
      ON DELETE CASCADE
);

CREATE TABLE PRODUCTOS(
  NOMBRE VARCHAR(20) NOT NULL,
  PRECIO REAL CHECK (PRECIO >= 0) NOT NULL,
  STOCK INT CHECK (STOCK >= 0) NULL,
  PRIMARY KEY(NOMBRE)
);

/*
 * Es necesario un trigger para calcular el stock del producto ya que en el cálculo intervienen elementos de otras tablas
 */

CREATE TABLE ASIGNACION_DE_PRODUCTOS(
  PRODUCTO VARCHAR(20) NOT NULL,
  ZONA INT NOT NULL,
  FECHA DATE NOT NULL,
  CANTIDAD INT NOT NULL,
  STOCK INT CHECK (STOCK >= 0) NULL,
  PRIMARY KEY(PRODUCTO, ZONA, FECHA),
  CONSTRAINT FK_PRODUCTOS
    FOREIGN KEY(PRODUCTO)
      REFERENCES PRODUCTOS(NOMBRE)
      ON DELETE CASCADE,
  CONSTRAINT FK_ZONAS
    FOREIGN KEY(ZONA)
      REFERENCES ZONAS(ID)
      ON DELETE CASCADE
);

/*
 * Es necesario un trigger para calcular el stock del producto DE LA ZONA ya que en el cálculo intervienen elementos de otras tablas
 */

CREATE TABLE EMPLEADOS(
  DNI VARCHAR(9) NOT NULL UNIQUE,
  NOMBRE VARCHAR(20) NULL,
  APELLIDO1 VARCHAR(20) NULL,
  APELLIDO2 VARCHAR(20) NULL,
  FECHA_NACIMIENTO DATE CHECK (FECHA_NACIMIENTO < CURRENT_DATE) NULL,
  ZONA_ASIGNADA INT NULL,
  EDAD INTERVAL NULL,
  PRODUCTIVIDAD REAL NULL,
  CONSTRAINT FK_ZONAS_EMPLEADOS
    FOREIGN KEY(ZONA_ASIGNADA)
      REFERENCES ZONAS(ID)
      ON DELETE SET NULL
);

/*
 * Es necesario un trigger para calcular la productividad del empleado ya que en el cálculo intervienen elementos de otras tablas
 * Es necesario un trigger o view para calcular la edad ya que postgresql no permite el uso de generated always as y virtual
 */

CREATE TABLE COMPRAS(
  CLIENTE VARCHAR(9) NOT NULL,
  PRODUCTO VARCHAR(20) NULL,
  FECHA DATE CHECK (FECHA <= CURRENT_DATE) NULL,
  CANTIDAD INT CHECK (CANTIDAD > 0) NOT NULL,
  EMPLEADO_ASIGNADO VARCHAR(9) NOT NULL,
  MIEMBRO_EN_LA_FECHA BOOLEAN NULL,
  CONSTRAINT FK_CLIENTES_COMPRAS
    FOREIGN KEY(CLIENTE) 
      REFERENCES CLIENTES(DNI)
	    ON DELETE CASCADE,
  CONSTRAINT FK_PRODUCTOS_COMPRAS
    FOREIGN KEY(PRODUCTO)
      REFERENCES PRODUCTOS(NOMBRE)
      ON DELETE CASCADE,
  CONSTRAINT FK_EMPLEADOS_COMPRAS
    FOREIGN KEY(EMPLEADO_ASIGNADO)
      REFERENCES EMPLEADOS(DNI)
      ON DELETE SET NULL
);

/*
 * Es necesario un trigger para calcular si el cliente es miembro del club en la fecha ya que en el cálculo intervienen elementos de otras tablas
 */

CREATE TABLE TELEFONOS_CLIENTES(
  DNI VARCHAR(9) NOT NULL,
  NUMERO BIGINT CHECK (NUMERO <= 99999999999) NOT NULL,
  PRIMARY KEY(NUMERO),
  CONSTRAINT FK_TELEFONOS_CLIENTES
    FOREIGN KEY(DNI)
      REFERENCES CLIENTES(DNI)
      ON DELETE CASCADE
);

CREATE TABLE EMAIL_CLIENTES(
  DNI VARCHAR(9) NOT NULL,
  CORREO VARCHAR(50) NOT NULL,
  PRIMARY KEY(CORREO),
  CONSTRAINT FK_CORREOS_CLIENTES
    FOREIGN KEY(DNI)
      REFERENCES CLIENTES(DNI)
      ON DELETE CASCADE
);

CREATE TABLE TELEFONOS_EMPLEADOS(
  DNI VARCHAR(9) NOT NULL,
  NUMERO BIGINT CHECK (NUMERO <= 99999999999) NOT NULL,
  PRIMARY KEY(NUMERO),
  CONSTRAINT FK_TELEFONOS_EMPLEADOS
    FOREIGN KEY(DNI)
      REFERENCES EMPLEADOS(DNI)
      ON DELETE CASCADE
);

CREATE TABLE EMAIL_EMPLEADOS(
  DNI VARCHAR(9) NOT NULL,
  CORREO VARCHAR(50) NOT NULL,
  PRIMARY KEY(CORREO),
  CONSTRAINT FK_CORREOS_EMPLEADOS
    FOREIGN KEY(DNI)
      REFERENCES EMPLEADOS(DNI)
      ON DELETE CASCADE
);

INSERT INTO CLIENTES(DNI, NOMBRE, APELLIDO1, APELLIDO2, FECHA_NACIMIENTO)
VALUES
  ('78567244L', 'Daniela', 'Armada', 'Cruz', '2001-02-11'),
  ('32659284H', 'Juan', 'Hernandez', 'de Rada', '2000-05-10'),
  ('57128649T', 'Pedro', 'Cabrera', 'de Dios', '2003-08-05'),
  ('84252596C', 'Miguel', 'Suarez', 'Garcia', '1999-05-23'),
  ('98444158M', 'Luis', 'Gonzalez', 'Muñoz', '1999-01-02');

INSERT INTO VIVEROS(NOMBRE, LUGAR)
VALUES
  ('VIVERO ESTACION', 'ANDALUCIA'),
  ('ULTRA VENTAS', 'CANARIAS'),
  ('ALCAMPO VIVERO', 'CANTABRIA'),
  ('AGUACATE', 'CATALUÑA'),
  ('VENTAS TOTAL', 'MADRID');

INSERT INTO ZONAS(LATITUD, LONGITUD, NOMBRE, VIVERO)
VALUES
  ('70', '50', 'ZONA SUPERIOR', 'VIVERO ESTACION'),
  ('10', '-80', 'ZONA PRINCIPAL', 'ULTRA VENTAS'),
  ('75', '-5', 'ENTRADA', 'VIVERO ESTACION'),
  ('56', '55', 'SOTANO', 'VENTAS TOTAL'),
  ('-70', '80', 'ZONA 1', 'AGUACATE');

INSERT INTO EMPLEADOS(DNI, NOMBRE, APELLIDO1, APELLIDO2, FECHA_NACIMIENTO, ZONA_ASIGNADA)
VALUES
  ('58567241L', 'Pedro', 'Cabeza', 'Cruz', '2001-01-12', 1),
  ('22659282H', 'Armando', 'Hernandez', 'Araujo', '2000-11-15', 2),
  ('17128643T', 'Isis', 'Cabrera', 'Gonzalez', '2001-12-15', 3),
  ('34252594C', 'Sandra', 'Hernandez', 'Garcia', '1998-03-13', 3),
  ('48444155M', 'Jose', 'Gonzalez', 'Herrador', '1993-10-12', 5);

INSERT INTO TELEFONOS_CLIENTES(DNI, NUMERO)
VALUES
  ('78567244L', 34688677714),
  ('78567244L', 34677112465),
  ('32659284H', 34655776341),
  ('32659284H', 34699090001),
  ('84252596C', 34651118374);

INSERT INTO EMAIL_CLIENTES(DNI, CORREO)
VALUES
  ('78567244L', 'alu01@ull.edu.es'),
  ('78567244L', 'peña@gmail.com'),
  ('57128649T', 'tabasco013@hotmail.es'),
  ('78567244L', 'ventasiempre100@gmail.com'),
  ('98444158M', 'elguarda11@gmail.com');

INSERT INTO TELEFONOS_EMPLEADOS(DNI, NUMERO)
VALUES
  ('58567241L', 34688677714),
  ('58567241L', 34677112465),
  ('17128643T', 34655776341),
  ('48444155M', 34699090001),
  ('17128643T', 34651118374);

INSERT INTO EMAIL_EMPLEADOS(DNI, CORREO)
VALUES
  ('58567241L', 'alu01@ull.edu.es'),
  ('58567241L', 'peña@gmail.com'),
  ('17128643T', 'tabasco013@hotmail.es'),
  ('48444155M', 'ventasiempre100@gmail.com'),
  ('17128643T', 'elguarda11@gmail.com');

INSERT INTO CLUB(DNI, FECHA_INCLUSION, FECHA_CADUCIDAD)
VALUES
  ('78567244L', '2022-01-01', '2022-02-01'),
  ('32659284H', '2022-02-01', '2022-03-01'),
  ('32659284H', '2022-01-01', '2022-02-01'),
  ('57128649T', '2023-07-02', '2023-08-02'),
  ('98444158M', '2023-08-10', '2023-09-10');

INSERT INTO PRODUCTOS(NOMBRE, PRECIO)
VALUES
  ('Atún Molino', 5),
  ('Millo Verde', 3),
  ('Manzanas Royal', 2),
  ('Pasta Estilo', 8),
  ('Papel A5', 12);

INSERT INTO COMPRAS(CLIENTE, PRODUCTO, FECHA, CANTIDAD, EMPLEADO_ASIGNADO)
VALUES
  ('78567244L', 'Atún Molino', '2022-01-05', 10, '58567241L'),
  ('78567244L', 'Millo Verde', '2022-05-01', 3, '58567241L'),
  ('32659284H', 'Manzanas Royal', '2022-03-11', 5, '34252594C'),
  ('84252596C', 'Pasta Estilo', '2022-02-12', 6, '58567241L'),
  ('32659284H', 'Papel A5', '2022-07-08', 9, '22659282H');

INSERT INTO ASIGNACION_DE_PRODUCTOS(PRODUCTO, ZONA, FECHA, CANTIDAD)
VALUES
  ('Papel A5', 1, '2022-01-05', 1),
  ('Manzanas Royal', 1, '2022-05-01', 2),
  ('Papel A5', 2, '2022-03-11', 50),
  ('Millo Verde', 1, '2022-02-12', 8),
  ('Atún Molino', 4, '2022-07-08', 12);

DELETE FROM CLIENTES
WHERE DNI = '78567244L';

DELETE FROM EMPLEADOS
WHERE NOMBRE = 'Jose';

DELETE FROM PRODUCTOS
WHERE PRECIO = 12;

DELETE FROM CLUB
WHERE FECHA_INCLUSION >= '2022-01-02';

SELECT * FROM CLIENTES;
SELECT * FROM CLUB;
SELECT * FROM EMPLEADOS;
SELECT * FROM VIVEROS;
SELECT * FROM ZONAS;
SELECT * FROM PRODUCTOS;
SELECT * FROM COMPRAS;
SELECT * FROM ASIGNACION_DE_PRODUCTOS;
SELECT * FROM TELEFONOS_CLIENTES;
SELECT * FROM TELEFONOS_EMPLEADOS;
SELECT * FROM EMAIL_CLIENTES;
SELECT * FROM EMAIL_EMPLEADOS;
